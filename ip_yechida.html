<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>יחידת לימוד: עולם כתובת ה-IP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        body {
            font-family: 'Assistant', sans-serif;
            background-color: #f0f4f8;
        }
        #main-content, #teacher-view, #student-view {
            display: none;
        }
        #welcome-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        .role-card {
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .role-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .tab-btn {
            transition: all 0.3s ease;
        }
        .tab-btn.active {
            background-color: #2563eb;
            color: white;
            border-color: #2563eb;
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .popup-link {
            color: #1d4ed8;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 1px dotted #1d4ed8;
        }
        .popup {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .popup-content {
            animation: slideIn 0.3s;
        }
        @keyframes slideIn {
            from { transform: translateY(-30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .simulation-canvas {
            background: #e0e7ff;
            border: 2px solid #a5b4fc;
            position: relative;
            overflow: hidden;
            height: 400px;
        }
        .sim-device, .sim-router, .sim-internet {
            position: absolute;
            transition: all 0.5s ease-in-out;
            text-align: center;
        }
        .sim-packet {
            position: absolute;
            width: 20px;
            height: 15px;
            background-color: #f59e0b;
            border: 1px solid #d97706;
            border-radius: 3px;
            z-index: 10;
            transition: all 1s linear;
        }
        .question-feedback {
            display: none;
            padding: 8px;
            margin-top: 8px;
            border-radius: 8px;
        }
        .correct {
            background-color: #dcfce7;
            color: #166534;
            border: 1px solid #86efac;
        }
        .incorrect {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }
        #worksheet-results .question-result {
            border-right: 4px solid;
            transition: background-color: 0.3s;
        }
         #worksheet-results .question-result:hover {
            background-color: #f9fafb;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Welcome Screen -->
    <div id="welcome-screen">
        <div class="text-center p-8">
            <h1 class="text-5xl font-bold text-blue-700 mb-4">ברוכים הבאים ליחידת הלימוד</h1>
            <p class="text-2xl text-gray-600 mb-12">בחרו את תפקידכם כדי להתחיל</p>
            <div class="flex justify-center gap-8">
                <!-- Teacher Card -->
                <div id="teacher-btn" class="role-card cursor-pointer bg-white p-8 rounded-lg shadow-lg w-64 text-center">
                    <svg class="w-24 h-24 mx-auto text-indigo-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21v-1a6 6 0 00-5.176-5.97M15 21h6v-1a6 6 0 00-9-5.197"></path></svg>
                    <h2 class="text-3xl font-bold">מורה</h2>
                </div>
                <!-- Student Card -->
                <div id="student-btn" class="role-card cursor-pointer bg-white p-8 rounded-lg shadow-lg w-64 text-center">
                    <svg class="w-24 h-24 mx-auto text-teal-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                    <h2 class="text-3xl font-bold">תלמיד</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Student View (Code Entry) -->
    <div id="student-view">
         <div class="flex justify-center items-center min-h-screen">
            <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md text-center">
                <h2 class="text-3xl font-bold text-blue-700 mb-4">התחברות לכיתה</h2>
                <p class="text-gray-600 mb-6">הזינו את שמכם ואת הקוד שקיבלתם מהמורה.</p>
                <div class="space-y-4">
                     <input type="text" id="student-name-input" placeholder="השם המלא שלך" class="w-full p-3 border border-gray-300 rounded-lg text-lg text-center focus:ring-2 focus:ring-blue-500">
                    <input type="text" id="room-code-input" placeholder="קוד כיתה" class="w-full p-3 border border-gray-300 rounded-lg text-lg text-center tracking-widest font-mono focus:ring-2 focus:ring-blue-500">
                    <button id="join-room-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg text-xl">התחבר והתחל ללמוד</button>
                </div>
                <p id="student-error" class="text-red-500 mt-4 h-4"></p>
            </div>
        </div>
    </div>

    <!-- Main Content (hidden initially) -->
    <div id="main-content" class="container mx-auto p-4 md:p-8">

        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-blue-700">יחידת לימוד: עולם כתובת ה-IP</h1>
            <p class="text-lg text-gray-600 mt-2">המדריך האינטראקטיבי להבנת הכתובת של כל מכשיר באינטרנט</p>
        </header>

        <!-- Teacher View (Code Display & Results) -->
        <div id="teacher-view" class="mb-8 bg-indigo-100 border-2 border-indigo-300 p-6 rounded-lg shadow-md">
            <div class="flex justify-between items-start">
                <div>
                    <h2 class="text-2xl font-bold text-indigo-800">פאנל המורה</h2>
                    <p class="text-indigo-700 mt-2">שתפו את הקוד הבא עם תלמידיכם. תוצאותיהם יופיעו כאן באופן אוטומטי.</p>
                </div>
                <button id="download-results-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                    הורד תוצאות (CSV)
                </button>
            </div>
            <div class="my-4 p-4 bg-white rounded-lg text-center">
                <span class="text-4xl font-mono tracking-widest text-indigo-900" id="room-code-display">טוען...</span>
            </div>
            <h3 class="text-xl font-bold text-indigo-800 mt-6">תוצאות התלמידים:</h3>
            <div id="teacher-results-display" class="mt-2 p-2 bg-white rounded-lg min-h-[50px]">
                <p class="text-gray-500 text-center p-4">ממתין לתוצאות...</p>
            </div>
        </div>

        <!-- Tabs Navigation -->
        <div class="mb-6 border-b border-gray-300">
            <nav class="flex flex-wrap -mb-px" id="tabs-nav">
                <button class="tab-btn active text-lg font-semibold py-3 px-6 border-b-2 border-transparent rounded-t-lg" data-tab="learning">למידה</button>
                <button class="tab-btn text-lg font-semibold py-3 px-6 border-b-2 border-transparent rounded-t-lg" data-tab="simulation">סימולציה</button>
                <button class="tab-btn text-lg font-semibold py-3 px-6 border-b-2 border-transparent rounded-t-lg" data-tab="quiz">חידון מהיר</button>
                <button class="tab-btn text-lg font-semibold py-3 px-6 border-b-2 border-transparent rounded-t-lg" data-tab="worksheet">דף עבודה</button>
            </nav>
        </div>

        <!-- Tabs Content -->
        <div id="tabs-content">
            <!-- Learning Tab -->
            <div id="learning" class="tab-content bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-3xl font-bold text-blue-600 mb-4">מהי כתובת IP? בואו נפרק את זה</h2>
                <p class="mb-6 text-gray-700">דמיינו את האינטרנט כעיר ענקית, וכל מכשיר (מחשב, טלפון, טלוויזיה חכמה) הוא בית. כדי לשלוח ולקבל מידע (כמו מכתבים או חבילות), כל בית צריך כתובת ייחודית. כתובת IP היא בדיוק זה - הכתובת הדיגיטלית של כל מכשיר ברשת.</p>
                <div class="space-y-3" id="accordion">
                    <div class="border border-gray-200 rounded-lg">
                        <button class="accordion-header w-full text-right p-4 bg-gray-50 hover:bg-gray-100 flex justify-between items-center">
                            <span class="font-semibold text-xl text-gray-700">מהי כתובת IP (Internet Protocol)?</span>
                            <svg class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div class="accordion-content p-5 bg-white border-t border-gray-200">
                             <p>כתובת IP היא מספר ייחודי המוקצה לכל <span class="popup-link" data-term="device">מכשיר</span> המחובר ל<span class="popup-link" data-term="network">רשת</span>, כמו ה<span class="popup-link" data-term="internet">אינטרנט</span>. היא משמשת לשתי מטרות עיקריות: <br><strong>1. זיהוי:</strong> היא מזהה באופן ייחודי את המכשיר ברשת. <br><strong>2. מיקום:</strong> היא מציינת את מיקומו הווירטואלי של המכשיר, ומאפשרת ניתוב מידע אליו וממנו. <br>הגרסה הנפוצה ביותר כיום נקראת IPv4.</p>
                        </div>
                    </div>
                    <div class="border border-gray-200 rounded-lg">
                        <button class="accordion-header w-full text-right p-4 bg-gray-50 hover:bg-gray-100 flex justify-between items-center">
                            <span class="font-semibold text-xl text-gray-700">מבנה כתובת IPv4</span>
                            <svg class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div class="accordion-content p-5 bg-white border-t border-gray-200">
                            <p class="mb-4">כתובת IPv4 מורכבת מ-32 <span class="popup-link" data-term="bit">סיביות (ביטים)</span>, המחולקות לארבעה חלקים הנקראים <span class="popup-link" data-term="octet">אוקטטות</span>. כל אוקטטה מכילה 8 סיביות. כדי שיהיה לנו, בני האדם, קל יותר לקרוא את הכתובת, אנחנו משתמשים בשיטת רישום שנקראת "עשרונית מנוקדת" (Dotted Decimal Notation).</p>
                             <div class="bg-indigo-100 p-4 rounded-lg text-center font-mono text-xl text-indigo-800">192.168.1.10</div>
                            <p class="mt-4">בדוגמה זו, כל מספר (192, 168, 1, 10) הוא אוקטטה, והוא מייצג 8 סיביות בבסיס <span class="popup-link" data-term="binary">בינארי</span>. כל מספר באוקטטה יכול להיות בין 0 ל-255.</p>
                        </div>
                    </div>
                    <div class="border border-gray-200 rounded-lg">
                        <button class="accordion-header w-full text-right p-4 bg-gray-50 hover:bg-gray-100 flex justify-between items-center">
                            <span class="font-semibold text-xl text-gray-700">חלק הרשת (Network) וחלק המארח (Host)</span>
                            <svg class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div class="accordion-content p-5 bg-white border-t border-gray-200">
                            <p>כל כתובת IP מחולקת לשני חלקים עיקריים: <br><strong>- מזהה הרשת (Network ID):</strong> החלק הראשון של הכתובת שמזהה את הרשת הספציפית שהמכשיר מחובר אליה. כל המכשירים באותה רשת חולקים את אותו מזהה רשת. <br><strong>- מזהה המארח (Host ID):</strong> החלק השני של הכתובת שמזהה מכשיר ספציפי (מארח) בתוך אותה רשת. <br><br>כדי לדעת איפה נגמר חלק הרשת ומתחיל חלק המארח, אנחנו משתמשים ב<span class="popup-link" data-term="subnet">מסכת רשת משנה (Subnet Mask)</span>.</p>
                        </div>
                    </div>
                </div>
            </div>
            <div id="simulation" class="tab-content bg-white p-6 rounded-lg shadow-md hidden">
                <h2 class="text-3xl font-bold text-blue-600 mb-4">סימולציה: רשת בפעולה</h2>
                <p class="mb-4 text-gray-700">בואו נראה איך כתובות IP עובדות בזמן אמת. לחצו על הכפתורים כדי להפעיל תרחישים שונים ברשת הדמיונית שלנו (192.168.1.0).</p>
                <div class="flex flex-wrap gap-4 mb-4">
                    <button id="sim-add-pc" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">חבר מחשב חדש</button>
                    <button id="sim-send-internal" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">שלח נתונים בתוך הרשת</button>
                    <button id="sim-send-external" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg">שלח נתונים לאינטרנט</button>
                    <button id="sim-reset" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">אפס סימולציה</button>
                </div>
                <div class="simulation-canvas" id="sim-canvas"></div>
                <div id="sim-log" class="mt-4 p-4 bg-gray-100 rounded-lg h-32 overflow-y-auto border border-gray-300">
                    <p class="font-mono text-sm text-gray-600">יומן אירועים יופיע כאן...</p>
                </div>
            </div>
            <div id="quiz" class="tab-content bg-white p-6 rounded-lg shadow-md hidden">
                <h2 class="text-3xl font-bold text-blue-600 mb-4">חידון מהיר: בחן את עצמך!</h2>
                <div id="quiz-container" class="max-w-2xl mx-auto"></div>
            </div>
            <div id="worksheet" class="tab-content bg-white p-6 rounded-lg shadow-md hidden">
                 <div id="worksheet-intro">
                    <h2 class="text-3xl font-bold text-blue-600 mb-4">דף עבודה: העמקת הידע</h2>
                    <p class="mb-6 text-gray-700">כעת, לאחר שלמדנו את היסודות, הגיע הזמן ליישם. דף העבודה הבא יבחן את הבנתכם בנושא באמצעות שאלות ברמות חשיבה שונות, על פי הטקסונומיה של בלום. התשובות הפתוחות ייבדקו באמצעות בינה מלאכותית שתספק לכם משוב אישי.</p>
                    <div class="text-center">
                        <button id="start-worksheet-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-lg text-xl shadow-lg transform hover:scale-105 transition-transform">התחל דף עבודה</button>
                    </div>
                </div>
                <div id="worksheet-content" class="hidden"></div>
                 <div id="worksheet-results" class="hidden mt-8"></div>
            </div>
        </div>

    </div>

    <!-- Popup Modal -->
    <div id="popup-modal" class="popup">
        <div class="popup-content bg-white rounded-lg shadow-xl w-11/12 md:max-w-xl mx-auto mt-20 p-6 relative">
            <button id="close-popup" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800">&times;</button>
            <h3 id="popup-title" class="text-2xl font-bold text-blue-600 mb-4"></h3>
            <p id="popup-text" class="text-gray-700"></p>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, serverTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase & App State ---
        let db, auth, userId, userRole, roomId, studentName, quizFinalScore;
        let teacherStudentData = []; // To hold data for CSV export
        
        // --- !!! נדרש שינוי להרצה ב-GitHub Pages או סביבה חיצונית !!! ---
        // 1. צור פרויקט חדש ב-Firebase Console (console.firebase.google.com).
        // 2. בפרויקט, הוסף אפליקציית אינטרנט (Web App).
        // 3. הפעל את שירות Firestore Database (ב-Test Mode).
        // 4. העתק את אובייקט התצורה (firebaseConfig) שקיבלת והדבק אותו כאן במקום האובייקט לדוגמה.
        const firebaseConfig = {
           apiKey: "AIzaSyBw52T-wDS5YPlH4kkUNTIqzVRAtxeWHd8",
           authDomain: "learning-unit-21661.firebaseapp.com",
           projectId: "learning-unit-21661",
           storageBucket: "learning-unit-21661.appspot.com",
           messagingSenderId: "93147892442",
           appId: "1:93147892442:web:d25ffd3830c8d68f54b3e3",
           measurementId: "G-GV1M41HM5R"
        };
        const appId = 'ip-learning-unit-public'; // שם סטטי לאפליקציה
        // --- סוף אזור השינוי ---


        async function initializeFirebase() {
            try {
                // בדיקה אם המשתמש עדכן את פרטי התצורה
                if (firebaseConfig.apiKey === "YOUR_API_KEY") {
                    document.body.innerHTML = `<div class="flex items-center justify-center h-screen bg-red-100 text-red-800 p-8 text-center">
                        <div class="max-w-md">
                            <h1 class="text-3xl font-bold">שגיאת תצורה</h1>
                            <p class="mt-4 text-lg">נראה שלא עדכנת את פרטי ה-Firebase בקוד. פתח את קובץ ה-HTML, עבור לחלק ה-JavaScript (בסוף הקובץ) ופעל לפי ההוראות כדי להדביק את תצורת ה-Firebase האישית שלך.</p>
                        </div>
                    </div>`;
                    return false; // עצירת הריצה
                }
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                await signInAnonymously(auth);
                userId = auth.currentUser.uid;
                return true;
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                 document.body.innerHTML = `<div class="flex items-center justify-center h-screen bg-red-100 text-red-800 p-8 text-center">
                        <div class="max-w-md">
                            <h1 class="text-3xl font-bold">שגיאת התחברות</h1>
                            <p class="mt-4 text-lg">לא ניתן היה להתחבר לשירותי Firebase. ודא שפרטי התצורה שהזנת נכונים וששירות Firestore מופעל בפרויקט שלך.</p>
                        </div>
                    </div>`;
                return false;
            }
        }
        
        // --- Role Selection Logic ---
        // הקוד ימשיך לרוץ רק אם Firebase אותחל בהצלחה
        (async () => {
            const isFirebaseReady = await initializeFirebase();
            if (!isFirebaseReady) return;

            const welcomeScreen = document.getElementById('welcome-screen');
            const mainContent = document.getElementById('main-content');
            const studentView = document.getElementById('student-view');
            
            document.getElementById('teacher-btn').addEventListener('click', () => selectRole('teacher'));
            document.getElementById('student-btn').addEventListener('click', () => selectRole('student'));
            document.getElementById('join-room-btn').addEventListener('click', joinRoom);
            document.getElementById('download-results-btn').addEventListener('click', downloadResultsAsCSV);

            // הפעלת שאר הלוגיקה של האפליקציה...
            const allElements = document.querySelectorAll('button, input');
            allElements.forEach(el => { if (el.id !== 'teacher-btn' && el.id !== 'student-btn') el.disabled = false; });
            
        })();


        function selectRole(role) {
            userRole = role;
            document.getElementById('welcome-screen').style.display = 'none';

            if (role === 'teacher') {
                setupTeacherView();
            } else {
                document.getElementById('student-view').style.display = 'flex';
            }
        }

        async function setupTeacherView() {
            roomId = generateRoomCode();
            document.getElementById('room-code-display').textContent = roomId;
            document.getElementById('main-content').style.display = 'block';
            document.getElementById('teacher-view').style.display = 'block';

            const roomRef = collection(db, 'artifacts', appId, 'public/data/ip_unit_rooms', roomId, 'students');
            
            const roomDocRef = doc(db, 'artifacts', appId, 'public/data/ip_unit_rooms', roomId);
            await setDoc(roomDocRef, { createdAt: serverTimestamp(), owner: userId });

            onSnapshot(roomRef, (snapshot) => {
                const resultsDisplay = document.getElementById('teacher-results-display');
                teacherStudentData = []; // Clear previous data
                snapshot.forEach(doc => teacherStudentData.push({ id: doc.id, ...doc.data() }));
                
                if (teacherStudentData.length === 0) {
                    resultsDisplay.innerHTML = `<p class="text-gray-500 text-center p-4">ממתין לתוצאות...</p>`;
                    return;
                }
                
                resultsDisplay.innerHTML = '';
                
                teacherStudentData.sort((a,b) => (a.submittedAt?.toMillis() || 0) - (b.submittedAt?.toMillis() || 0));

                teacherStudentData.forEach(studentData => {
                    const worksheetScoreColor = studentData.score >= 85 ? 'bg-green-100 text-green-800' : (studentData.score >= 60 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800');
                    const quizScore = studentData.quizScore || 0;
                    const quizTotal = quizData.length || 10;
                    const quizScoreColor = (quizScore / quizTotal) >= 0.8 ? 'bg-green-100 text-green-800' : ((quizScore / quizTotal) >= 0.5 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800');

                    const studentDiv = document.createElement('div');
                    studentDiv.className = 'flex justify-between items-center p-3 border-b last:border-b-0';
                    studentDiv.innerHTML = `
                        <div class="flex-grow"><span class="font-semibold text-lg text-gray-700">${studentData.name}</span></div>
                        <div class="text-left flex-shrink-0">
                             <span class="font-semibold text-sm">דף עבודה: <span class="font-bold text-lg px-2 py-1 rounded-full ${worksheetScoreColor}">${studentData.score}</span></span>
                             <span class="font-semibold text-sm mr-4">חידון: <span class="font-bold text-lg px-2 py-1 rounded-full ${quizScoreColor}">${quizScore}/${quizTotal}</span></span>
                        </div>
                    `;
                    resultsDisplay.appendChild(studentDiv);
                });
            });
        }

        async function joinRoom() {
            const code = document.getElementById('room-code-input').value.trim().toUpperCase();
            const name = document.getElementById('student-name-input').value.trim();
            const errorEl = document.getElementById('student-error');

            if (!code || !name) {
                errorEl.textContent = 'יש למלא שם וקוד כיתה.';
                return;
            }

            const roomDocRef = doc(db, 'artifacts', appId, 'public/data/ip_unit_rooms', code);
            const docSnap = await getDoc(roomDocRef);

            if (docSnap.exists()) {
                roomId = code;
                studentName = name;
                document.getElementById('student-view').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
            } else {
                errorEl.textContent = 'קוד הכיתה שהוזן אינו תקין.';
            }
        }
        
        function downloadResultsAsCSV() {
            if (teacherStudentData.length === 0) {
                // במקום alert, נציג הודעה למשתמש
                const btn = document.getElementById('download-results-btn');
                const originalText = btn.textContent;
                btn.textContent = 'אין נתונים להורדה';
                btn.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                }, 2000);
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // \uFEFF for BOM for Excel
            csvContent += "שם התלמיד,ציון דף עבודה,ציון חידון\r\n";

            teacherStudentData.forEach(student => {
                const quizTotal = quizData.length || 10;
                const row = `"${student.name}",${student.score},"${student.quizScore}/${quizTotal}"`;
                csvContent += row + "\r\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `student_results_${roomId}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }


        function generateRoomCode() {
            return Math.random().toString(36).substring(2, 7).toUpperCase();
        }

        // --- Core Application Logic (original script) ---
        const tabsNav = document.getElementById('tabs-nav');
        const tabsContent = document.getElementById('tabs-content');

        tabsNav.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                tabsNav.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                tabsContent.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                e.target.classList.add('active');
                const tabId = e.target.getAttribute('data-tab');
                document.getElementById(tabId).classList.remove('hidden');
            }
        });

        const accordion = document.getElementById('accordion');
        accordion.addEventListener('click', (e) => {
            const header = e.target.closest('.accordion-header');
            if (header) {
                const content = header.nextElementSibling;
                const svg = header.querySelector('svg');
                accordion.querySelectorAll('.accordion-header').forEach(otherHeader => {
                    if (otherHeader !== header) {
                        otherHeader.nextElementSibling.style.maxHeight = null;
                        otherHeader.querySelector('svg').classList.remove('rotate-180');
                    }
                });
                if (content.style.maxHeight) {
                    content.style.maxHeight = null;
                    svg.classList.remove('rotate-180');
                } else {
                    content.style.maxHeight = content.scrollHeight + "px";
                    svg.classList.add('rotate-180');
                }
            }
        });

        const popupModal = document.getElementById('popup-modal');
        const popupTerms = {
            device: { title: 'מכשיר (Device)', text: 'כל רכיב חומרה שמסוגל להתחבר לרשת, כמו מחשב, טלפון חכם, מדפסת, או טלוויזיה חכמה.' },
            network: { title: 'רשת (Network)', text: 'אוסף של שני מכשירים או יותר המחוברים יחד כדי לשתף משאבים ומידע.' },
            internet: { title: 'אינטרנט (Internet)', text: 'רשת המחשבים הגלובלית, המורכבת ממיליוני רשתות פרטיות, ציבוריות, עסקיות וממשלתיות המחוברות ביניהן.' },
            bit: { title: 'סיבית (Bit)', text: 'יחידת המידע הבסיסית ביותר במחשוב. סיבית יכולה להכיל אחד משני ערכים בלבד: 0 או 1.' },
            octet: { title: 'אוקטטה (Octet)', text: 'קבוצה של 8 סיביות. בכתובת IPv4, כל אחד מארבעת המספרים מייצג אוקטטה.' },
            binary: { title: 'בסיס בינארי', text: 'שיטת ספירה המבוססת על שתי ספרות בלבד, 0 ו-1. זוהי השפה הבסיסית של מחשבים.' },
            subnet: { title: 'מסכת רשת משנה (Subnet Mask)', text: 'מספר שנראה כמו כתובת IP (למשל, 255.255.255.0) ועוזר למחשבים להבין איזה חלק של כתובת ה-IP הוא מזהה הרשת ואיזה חלק הוא מזהה המארח.' },
        };

        document.body.addEventListener('click', (e) => {
            if (e.target.classList.contains('popup-link')) {
                const term = e.target.dataset.term;
                document.getElementById('popup-title').textContent = popupTerms[term].title;
                document.getElementById('popup-text').textContent = popupTerms[term].text;
                popupModal.style.display = 'block';
            }
            if (e.target.id === 'close-popup' || e.target.id === 'popup-modal') {
                popupModal.style.display = 'none';
            }
        });

        const simCanvas = document.getElementById('sim-canvas');
        const simLog = document.getElementById('sim-log');
        let simDevices = [];
        let nextIp = 100;

        function addSimLog(message) {
            const p = document.createElement('p');
            p.className = "font-mono text-sm text-gray-800 animate-pulse";
            p.textContent = `> ${message}`;
            simLog.appendChild(p);
            simLog.scrollTop = simLog.scrollHeight;
            setTimeout(() => p.classList.remove('animate-pulse'), 500);
        }

        function createPacket(fromEl, toEl) {
            const packet = document.createElement('div');
            packet.className = 'sim-packet';
            simCanvas.appendChild(packet);
            const startPos = { x: fromEl.offsetLeft + fromEl.offsetWidth / 2, y: fromEl.offsetTop + fromEl.offsetHeight / 2 };
            const endPos = { x: toEl.offsetLeft + toEl.offsetWidth / 2, y: toEl.offsetTop + toEl.offsetHeight / 2 };
            packet.style.left = `${startPos.x}px`;
            packet.style.top = `${startPos.y}px`;
            setTimeout(() => {
                packet.style.left = `${endPos.x}px`;
                packet.style.top = `${endPos.y}px`;
            }, 100);
            setTimeout(() => packet.remove(), 1100);
        }

        function resetSimulation() {
            simCanvas.innerHTML = '';
            simDevices = [];
            nextIp = 100;
            simCanvas.innerHTML = `
                <div class="sim-router" style="top: 50%; left: 50%; transform: translate(-50%, -50%);">
                    <svg class="w-16 h-16 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7"></path><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>
                    <p class="font-bold">נתב</p><p class="text-sm">192.168.1.1</p>
                </div>
                <div class="sim-internet" style="top: 10px; left: 50%; transform: translateX(-50%);">
                    <svg class="w-20 h-20 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2h8a2 2 0 002-2v-1a2 2 0 012-2h1.945M7.721 16.542A9.023 9.023 0 0112 15c1.605 0 3.11.42 4.279 1.158M15 11V3m0 0l-3 3m3-3l3 3"></path></svg>
                    <p class="font-bold">אינטרנט</p>
                </div>`;
            simLog.innerHTML = `<p class="font-mono text-sm text-gray-600">הסימולציה אופסה. מוכנים להתחיל.</p>`;
        }
        
        document.getElementById('sim-reset').addEventListener('click', resetSimulation);

        document.getElementById('sim-add-pc').addEventListener('click', () => {
            if(simDevices.length >= 4) { addSimLog("הרשת מלאה! (בסימולציה זו)"); return; }
            addSimLog("מחשב חדש מתחבר ומבקש כתובת IP...");
            const deviceId = `pc-${simDevices.length}`;
            const ip = `192.168.1.${nextIp++}`;
            const deviceEl = document.createElement('div');
            deviceEl.id = deviceId;
            deviceEl.className = 'sim-device';
            deviceEl.innerHTML = `<svg class="w-12 h-12 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg><p class="font-bold">מחשב ${simDevices.length + 1}</p><p class="text-sm">${ip}</p>`;
            const positions = [{ top: '15%', left: '15%' }, { top: '15%', left: '85%' }, { top: '80%', left: '15%' }, { top: '80%', left: '85%' }];
            const pos = positions[simDevices.length];
            deviceEl.style.top = pos.top;
            deviceEl.style.left = pos.left;
            deviceEl.style.transform = 'translate(-50%, -50%)';
            simCanvas.appendChild(deviceEl);
            simDevices.push({ id: deviceId, ip: ip, el: deviceEl });
            setTimeout(() => {
                 createPacket(deviceEl, simCanvas.querySelector('.sim-router'));
                 setTimeout(() => {
                    createPacket(simCanvas.querySelector('.sim-router'), deviceEl);
                    addSimLog(`הנתב (DHCP) הקצה את הכתובת ${ip} למחשב החדש.`);
                 }, 1100)
            }, 500);
        });
        
        document.getElementById('sim-send-internal').addEventListener('click', () => {
            if (simDevices.length < 2) { addSimLog("צריך לפחות שני מחשבים ברשת כדי לשלוח נתונים ביניהם."); return; }
            const fromDevice = simDevices[0];
            const toDevice = simDevices[1];
            addSimLog(`מחשב 1 (${fromDevice.ip}) שולח נתונים למחשב 2 (${toDevice.ip})...`);
            createPacket(fromDevice.el, simCanvas.querySelector('.sim-router'));
            setTimeout(() => {
                 addSimLog(`הנתב בודק את כתובת היעד (${toDevice.ip})...`);
                 addSimLog(`היעד נמצא באותה רשת! מעביר את החבילה...`);
                 createPacket(simCanvas.querySelector('.sim-router'), toDevice.el);
                 setTimeout(()=> addSimLog("הנתונים הגיעו ליעד בהצלחה."), 1100);
            }, 1100);
        });

        document.getElementById('sim-send-external').addEventListener('click', () => {
            if (simDevices.length < 1) { addSimLog("צריך לחבר לפחות מחשב אחד לרשת."); return; }
             const fromDevice = simDevices[0];
            addSimLog(`מחשב 1 (${fromDevice.ip}) שולח נתונים לאתר חיצוני (לדוגמה, 8.8.8.8)...`);
            createPacket(fromDevice.el, simCanvas.querySelector('.sim-router'));
            setTimeout(() => {
                 addSimLog(`הנתב בודק את כתובת היעד (8.8.8.8)...`);
                 addSimLog(`היעד מחוץ לרשת המקומית! שולח את החבילה לאינטרנט...`);
                 createPacket(simCanvas.querySelector('.sim-router'), simCanvas.querySelector('.sim-internet'));
                 setTimeout(()=> addSimLog("הנתונים נשלחו לרשת האינטרנט."), 1100);
            }, 1100);
        });

        resetSimulation();
        
        const quizContainer = document.getElementById('quiz-container');
        const quizData = [
            { question: "מכמה סיביות (ביטים) מורכבת כתובת IPv4?", answers: ["8", "16", "32", "64"], correct: 2 },
            { question: "איך נקרא כל אחד מארבעת המספרים בכתובת IPv4?", answers: ["ביט", "בייט", "אוקטטה", "מילה"], correct: 2 },
            { question: "מה תפקידה של מסכת רשת משנה (Subnet Mask)?", answers: ["להגביר את מהירות האינטרנט", "להבדיל בין חלק הרשת לחלק המארח", "להצפין את המידע", "לשנות את כתובת ה-IP"], correct: 1 },
            { question: "איזו מהכתובות הבאות היא כתובת IP תקינה?", answers: ["192.168.1", "256.10.20.30", "10.0.0.255", "172.16.500.1"], correct: 2 },
            { question: "מהם שני התפקידים העיקריים של כתובת IP?", answers: ["מהירות ורוחב פס", "זיהוי ומיקום", "אבטחה והצפנה", "הורדה והעלאה"], correct: 1 },
            { question: "כמה אוקטטות יש בכתובת IPv4?", answers: ["2", "4", "6", "8"], correct: 1 },
            { question: "מהו הערך המקסימלי שיכול להיות לכל אוקטטה?", answers: ["100", "128", "255", "256"], correct: 2 },
            { question: "אם שני מחשבים נמצאים באותה רשת מקומית, מה יהיה משותף לכתובות ה-IP שלהם?", answers: ["מזהה המארח (Host ID)", "כלום", "האוקטטה האחרונה", "מזהה הרשת (Network ID)"], correct: 3 },
            { question: "התהליך שבו נתב מקצה כתובת IP באופן אוטומטי למחשב חדש נקרא:", answers: ["DNS", "HTML", "FTP", "DHCP"], correct: 3 },
            { question: "כאשר אתם גולשים לאתר אינטרנט, המחשב שלכם שולח בקשה לכתובת ה-IP של...", answers: ["הראוטר שלכם", "שרת האתר", "ספק האינטרנט", "המחשב שלכם"], correct: 1 }
        ];

        let currentQuestionIndex = 0;
        let score = 0;

        function loadQuiz() {
            currentQuestionIndex = 0;
            score = 0;
            quizFinalScore = null;
            showQuestion();
        }

        function showQuestion() {
            const currentQuestion = quizData[currentQuestionIndex];
            quizContainer.innerHTML = `<div class="bg-indigo-50 p-6 rounded-lg shadow"><p class="text-xl font-semibold mb-4">${currentQuestionIndex + 1}. ${currentQuestion.question}</p><div class="space-y-3">${currentQuestion.answers.map((answer, index) => `<button class="answer-btn block w-full text-right p-3 bg-white border border-gray-300 rounded-lg hover:bg-indigo-100 hover:border-indigo-400" data-index="${index}">${answer}</button>`).join('')}</div><div class="question-feedback mt-4"></div></div>`;
            quizContainer.querySelectorAll('.answer-btn').forEach(button => button.addEventListener('click', selectAnswer));
        }

        function selectAnswer(e) {
            const selectedButton = e.target;
            const selectedIndex = parseInt(selectedButton.dataset.index);
            const correctIndex = quizData[currentQuestionIndex].correct;
            const feedbackEl = quizContainer.querySelector('.question-feedback');
            quizContainer.querySelectorAll('.answer-btn').forEach(button => {
                button.disabled = true;
                if (parseInt(button.dataset.index) === correctIndex) {
                    button.classList.add('bg-green-200', 'border-green-500');
                }
            });
            if (selectedIndex === correctIndex) {
                score++;
                feedbackEl.textContent = "נכון! כל הכבוד!";
                feedbackEl.className = "question-feedback correct";
            } else {
                selectedButton.classList.add('bg-red-200', 'border-red-500');
                feedbackEl.textContent = `טעות. התשובה הנכונה היא: ${quizData[currentQuestionIndex].answers[correctIndex]}`;
                feedbackEl.className = "question-feedback incorrect";
            }
            feedbackEl.style.display = 'block';
            setTimeout(() => {
                currentQuestionIndex++;
                if (currentQuestionIndex < quizData.length) { showQuestion(); } else { showQuizResults(); }
            }, 2000);
        }

        function showQuizResults() {
             quizFinalScore = score; // Store the final score
             quizContainer.innerHTML = `<div class="text-center bg-white p-8 rounded-lg shadow-lg"><h3 class="text-3xl font-bold text-blue-700">סיימת את החידון!</h3><p class="text-2xl mt-4">הציון שלך: <span class="font-bold text-green-600">${score}</span> מתוך ${quizData.length}</p><p class="text-lg text-gray-600 mt-2">${score > 7 ? 'מצוין! יש לך הבנה טובה של הנושא.' : 'לא רע! כדאי לחזור על החומר כדי לחזק את הידע.'}</p><button id="restart-quiz" class="mt-6 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg">נסה שוב</button></div>`;
            document.getElementById('restart-quiz').addEventListener('click', loadQuiz);
        }
        
        loadQuiz();

        const worksheetIntro = document.getElementById('worksheet-intro');
        const worksheetContent = document.getElementById('worksheet-content');
        const worksheetResults = document.getElementById('worksheet-results');
        const startWorksheetBtn = document.getElementById('start-worksheet-btn');

        const worksheetQuestions = [
            { id: 'q1', type: 'mcq', bloom: 'ידע', question: 'מהם שני החלקים העיקריים של כתובת IP?', options: ['כתובת ציבורית וכתובת פרטית', 'חלק הרשת (Network ID) וחלק המארח (Host ID)', 'פרוטוקול TCP ופרוטוקול UDP', 'כתובת IPv4 וכתובת IPv6'], correct: 1, },
            { id: 'q2', type: 'open', bloom: 'הבנה', question: 'הסבירו במילים שלכם מדוע מסכת רשת משנה (Subnet Mask) היא חשובה.', guideline: 'מסכת רשת משנה חשובה כי היא מאפשרת למחשבים ולנתבים להבחין בין החלק בכתובת ה-IP שמייצג את הרשת לבין החלק שמייצג את המחשב הספציפי באותה רשת. ללא המסכה, המחשב לא יידע אם מכשיר אחר נמצא ברשת המקומית שלו או ברשת חיצונית, ולא ידע לאן לשלוח את המידע (ישירות למכשיר או לנתב).' },
            { id: 'q3', type: 'mcq', bloom: 'יישום', question: 'בהינתן כתובת IP 172.16.10.5 ומסכת רשת 255.255.0.0, מהו מזהה הרשת (Network ID)?', options: ['172.0.0.0', '172.16.0.0', '172.16.10.0', '172.16.10.5'], correct: 1, },
            { id: 'q4', type: 'open', bloom: 'אנליזה', question: 'השוו בין כתובת IP ציבורית לכתובת IP פרטית. מה ההבדל המרכזי ביניהן ומתי משתמשים בכל אחת?', guideline: 'ההבדל המרכזי הוא שכתובת IP ציבורית היא ייחודית בכל רחבי האינטרנט וניתנת לגישה מכל מקום, והיא מוקצית על ידי ספק האינטרנט. לעומת זאת, כתובת IP פרטית משמשת רק בתוך רשת מקומית (כמו בבית או במשרד), אינה ניתנת לגישה מהאינטרנט, ויכולה לחזור על עצמה ברשתות שונות (למשל, להרבה אנשים יש את הכתובת 192.168.1.10 בבית). משתמשים בציבורית לתקשורת עם האינטרנט, ובפרטית לתקשורת בין מכשירים בתוך הרשת המקומית. הנתב (ראוטר) מתרגם בין הכתובות באמצעות טכנולוגיה שנקראת NAT.' },
            { id: 'q5', type: 'open', bloom: 'הערכה', question: 'חברה זקוקה לרשת עבור 500 מחשבים. איזו קלאס של כתובות (A, B, או C - בהתעלם מ-CIDR) תהיה המתאימה ביותר ומדוע? נמקו את תשובתכם.', guideline: 'קלאס B תהיה המתאימה ביותר. קלאס C תומך רק בעד 254 מארחים (מחשבים), וזה לא מספיק עבור 500. קלאס A תומך במיליוני מארחים ויהיה בזבוז עצום של כתובות. קלאס B תומך בעד 65,534 מארחים, מה שנותן מספיק מקום ל-500 המחשבים וגם מאפשר גדילה עתידית בלי לבזבז יותר מדי כתובות.' }
        ];
        
        startWorksheetBtn.addEventListener('click', () => {
            worksheetIntro.classList.add('hidden');
            let formHTML = `<form id="worksheet-form" class="space-y-8">`;
            worksheetQuestions.forEach((q, index) => {
                formHTML += `<div class="p-5 border border-gray-200 rounded-lg bg-gray-50/50"><p class="mb-1 text-sm font-bold text-indigo-600">שאלה ${index + 1} - רמת חשיבה: ${q.bloom}</p><label class="text-xl font-semibold text-gray-800">${q.question}</label><div class="mt-4">`;
                if (q.type === 'mcq') {
                    q.options.forEach((opt, optIndex) => {
                        formHTML += `<div class="flex items-center mb-2"><input type="radio" id="${q.id}_${optIndex}" name="${q.id}" value="${optIndex}" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 focus:ring-blue-500"><label for="${q.id}_${optIndex}" class="ms-2 text-lg text-gray-700">${opt}</label></div>`;
                    });
                } else {
                     formHTML += `<textarea id="${q.id}" name="${q.id}" rows="4" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-lg"></textarea>`;
                }
                formHTML += `</div></div>`;
            });
            formHTML += `<div class="text-center"><button type="submit" id="submit-worksheet-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg text-xl shadow-lg transform hover:scale-105 transition-transform">בדוק ושלח למורה</button></div></form>`;
            worksheetContent.innerHTML = formHTML;
            worksheetContent.classList.remove('hidden');
            document.getElementById('worksheet-form').addEventListener('submit', handleWorksheetSubmit);
        });
        
        async function handleWorksheetSubmit(e) {
            e.preventDefault();
            const submitBtn = document.getElementById('submit-worksheet-btn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = `<span class="inline-flex items-center"><svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> מעבד...</span>`;
            
            const formData = new FormData(e.target);
            const userAnswers = {};
            for (let [key, value] of formData.entries()) { userAnswers[key] = value; }
            
            const results = [];
            for (const q of worksheetQuestions) {
                const userAnswer = userAnswers[q.id] || "";
                let result = { question: q.question, userAnswerText: userAnswer, score: 0, feedback: 'לא נענתה תשובה.', bloom: q.bloom, };
                if (q.type === 'mcq') {
                    result.userAnswerText = q.options[userAnswer] || "לא נבחר";
                    if (parseInt(userAnswer) === q.correct) { result.score = 100; result.feedback = 'תשובה נכונה! כל הכבוד.'; }
                    else { result.score = 0; result.feedback = `תשובה לא נכונה. התשובה הנכונה היא: "${q.options[q.correct]}".`; }
                    results.push(result);
                } else if (userAnswer.trim() !== "") {
                    const aiResult = await gradeWithAI(q.question, userAnswer, q.guideline);
                    result.score = aiResult.score; result.feedback = aiResult.feedback;
                    results.push(result);
                } else { results.push(result); }
            }
            
            displayWorksheetResults(results, userAnswers);
            worksheetContent.classList.add('hidden');
            
            if (userRole === 'student' && roomId) {
                submitResultsToTeacher(results);
            }
        }
        
        async function submitResultsToTeacher(worksheetResultsData) {
             const totalWorksheetScore = worksheetResultsData.reduce((sum, res) => sum + res.score, 0);
             const finalWorksheetScore = Math.round(totalWorksheetScore / worksheetResultsData.length);
             const studentResult = {
                 name: studentName,
                 score: finalWorksheetScore, // Main score is worksheet score
                 quizScore: quizFinalScore,
                 worksheetResults: worksheetResultsData,
                 submittedAt: serverTimestamp()
             };
             const resultDocRef = doc(db, 'artifacts', appId, 'public/data/ip_unit_rooms', roomId, 'students', userId);
             try {
                await setDoc(resultDocRef, studentResult, { merge: true });
                console.log("Results submitted successfully!");
             } catch (error) {
                console.error("Error submitting results:", error);
             }
        }

        async function gradeWithAI(question, answer, guideline, retries = 3, delay = 1000) {
             const apiKey = "";
             const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
             const systemPrompt = `You are a helpful and encouraging computer networking teacher grading a student's worksheet in Hebrew. The student's answer might be in Hebrew. Your feedback must be in Hebrew. Be lenient with the grading. If the student demonstrates a good understanding and is mostly correct, even if not perfectly phrased, grade it as 100. Your entire response must be a valid JSON object with two keys: "score" (a number between 0 and 100) and "feedback" (a brief, encouraging string in Hebrew). Do not add any text before or after the JSON object.`;
             const userQuery = `Grade the following student answer. Question: "${question}" Student's Answer: "${answer}" For your reference, a good answer would be something like: "${guideline}" Evaluate the student's answer and provide a score and feedback in Hebrew.`;
            const payload = { contents: [{ parts: [{ text: userQuery }] }], systemInstruction: { parts: [{ text: systemPrompt }] }, };
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (text) {
                        const jsonText = text.replace(/```json/g, '').replace(/```/g, '').trim();
                        return JSON.parse(jsonText);
                    }
                } catch (error) {
                    console.error(`Attempt ${i + 1} failed:`, error);
                    if (i === retries - 1) { return { score: 0, feedback: 'שגיאה בבדיקה האוטומטית. נסה שוב מאוחר יותר.' }; }
                    await new Promise(res => setTimeout(res, delay * Math.pow(2, i)));
                }
            }
            return { score: 0, feedback: 'שגיאה בבדיקה האוטומטית לאחר מספר ניסיונות.' };
        }

        function displayWorksheetResults(results, userAnswers) {
            worksheetResults.classList.remove('hidden');
            let totalScore = 0;
            let resultsHTML = `<div id="worksheet-to-download"> <h2 class="text-3xl font-bold text-blue-600 mb-6 text-center">סיכום דף העבודה</h2>`;
            results.forEach((res, index) => {
                totalScore += res.score;
                const scoreColor = res.score >= 80 ? 'border-green-500' : (res.score >= 50 ? 'border-yellow-500' : 'border-red-500');
                let userAnswerDisplay = worksheetQuestions[index].type === 'mcq' ? (worksheetQuestions[index].options[userAnswers[worksheetQuestions[index].id]] || "לא נענתה") : (userAnswers[worksheetQuestions[index].id] || "לא נענתה");
                resultsHTML += `<div class="question-result mb-6 p-4 border-r-4 rounded-md bg-white shadow-sm ${scoreColor}"><p class="text-lg font-semibold text-gray-800">${index + 1}. ${res.question}</p><p class="mt-2 text-md text-gray-600 bg-gray-50 p-2 rounded-md"><strong>תשובתך:</strong> ${userAnswerDisplay}</p><div class="mt-3 p-3 rounded-md ${res.score >= 80 ? 'bg-green-50' : 'bg-red-50'}"><p class="font-bold text-lg ${res.score >= 80 ? 'text-green-800' : 'text-red-800'}">ציון: ${res.score}/100</p><p class="text-md ${res.score >= 80 ? 'text-green-700' : 'text-red-700'}"><strong>משוב:</strong> ${res.feedback}</p></div></div>`;
            });
            const finalScore = Math.round(totalScore / results.length);
            const finalFeedback = finalScore >= 85 ? 'עבודה מצוינת! ניכרת הבנה מעמיקה של החומר.' : (finalScore >= 60 ? 'הבנה טובה של הנושא, יש מקום לחידוד מספר נקודות.' : 'כדאי לחזור על יחידת הלימוד כדי לחזק את היסודות.');
            const finalScoreColor = finalScore >= 85 ? 'text-green-600' : (finalScore >= 60 ? 'text-yellow-600' : 'text-red-600');
            resultsHTML += `<div class="mt-10 p-6 bg-indigo-100 rounded-lg text-center shadow-inner"><h3 class="text-2xl font-bold text-indigo-800">ציון סופי</h3><p class="text-5xl font-bold my-2 ${finalScoreColor}">${finalScore}</p><p class="text-lg text-indigo-700">${finalFeedback}</p></div></div><div class="text-center mt-8"><button id="download-worksheet-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-lg text-xl shadow-lg">הורד דף עבודה (PDF)</button></div>`;
            worksheetResults.innerHTML = resultsHTML;
            document.getElementById('download-worksheet-btn').addEventListener('click', () => {
                 const { jsPDF } = window.jspdf;
                 const element = document.getElementById('worksheet-to-download');
                 html2canvas(element, { scale: 2 }).then(canvas => {
                     const imgData = canvas.toDataURL('image/png');
                     const pdf = new jsPDF('p', 'mm', 'a4');
                     const pdfWidth = pdf.internal.pageSize.getWidth();
                     const canvasWidth = canvas.width;
                     const canvasHeight = canvas.height;
                     const ratio = canvasWidth / canvasHeight;
                     const width = pdfWidth - 20;
                     const height = width / ratio;
                     let position = 10;
                     pdf.addImage(imgData, 'PNG', 10, position, width, height);
                     pdf.save('ip-worksheet-results.pdf');
                 });
            });
        }
    </script>

</body>
</html>


